<script lang="ts">
    import type { Writable } from "svelte/store";
    import type { ItemA5e } from "../../../documents/item/item";

    import { getContext } from "svelte";
    import { localize } from "#runtime/util/i18n";

    import GenericConfigDialog from "../../dialogs/initializers/GenericConfigDialog";

    import getOrdinalNumber from "../../../utils/getOrdinalNumber";
    import updateAssociatedValues from "../../handlers/updateAssociatedValues";
    import updateDocumentDataFromField from "../../../utils/updateDocumentDataFromField";

    import AreaConfig from "../itemActionsConfig/AreaConfig.svelte";
    import Checkbox from "../Checkbox.svelte";
    import FieldWrapper from "../FieldWrapper.svelte";
    import Section from "../Section.svelte";
    import TargetRangeIncrement from "../itemActionsConfig/TargetRangeIncrement.svelte";
    import TargetScalingDialog from "../../dialogs/TargetScalingDialog.svelte";

    const actionId: string = getContext("actionId");
    const appId = getContext("appId");
    const item: Writable<ItemA5e> = getContext("item");
    const { A5E } = CONFIG;
    const { isEmpty } = foundry.utils;

    function onClickTargetScalingButton() {
        let dialog = $item.dialogs.targetScaling[actionId];

        if (!dialog) {
            $item.dialogs.targetScaling[actionId] = new GenericConfigDialog(
                $item,
                `${$item.name} Target Scaling Configuration`,
                TargetScalingDialog,
                { actionId },
            );

            dialog = $item.dialogs.targetScaling[actionId];
        }

        dialog.render(true);
    }

    function addRangeIncrement() {
        const newRange = {
            range: "",
        };

        $item.update({
            [`system.actions.${actionId}.ranges`]: {
                ...action.ranges,
                [foundry.utils.randomID()]: newRange,
            },
        });
    }

    function selectTarget(event) {
        const selectedOption = event.target?.selectedOptions[0]?.value;
        if (selectedOption === "null") {
            $item.update({
                [`system.actions.${actionId}`]: {
                    "-=target": null,
                },
            });
        } else {
            updateAssociatedValues(
                $item,
                `system.actions.${actionId}.target.type`,
                selectedOption,
                `system.actions.${actionId}.target.quantity`,
            );
        }
    }

    $: action = $item.actions.get(actionId)!;
</script>

<section class="a5e-page-wrapper">
    <Section
        heading="A5E.TabRanges"
        headerButtons={[
            {
                classes: "add-button",
                label: "A5E.ButtonAddRangeIncrement",
                handler: addRangeIncrement,
            },
        ]}
        --a5e-section-gap="0"
    >
        <ul class="a5e-item-list">
            {#each Object.entries(action.ranges ?? {}) as [id, range], index (id)}
                <li class="a5e-item a5e-item--action-config" data-range-id={id}>
                    <TargetRangeIncrement {index} {id} rangeObject={range} />
                </li>
            {/each}
        </ul>
    </Section>

    <AreaConfig {action} {actionId} {item} />

    <Section heading="Target" --a5e-section-gap="0.5rem">
        <FieldWrapper>
            <div class="action-config__component">
                {#if ["creature", "object", "creatureObject"].includes(action.target?.type)}
                    <input
                        class="small-input"
                        style="width: 5rem;"
                        type="number"
                        name="targetQuantity"
                        value={action.target?.quantity ?? 1}
                        on:change={({ target }) =>
                            updateDocumentDataFromField(
                                $item,
                                `system.actions.${actionId}.target.quantity`,
                                // @ts-expect-error
                                Number(target.value || 0),
                            )}
                        on:click={({ target }) => {
                            // @ts-expect-error
                            target.select();
                        }}
                    />
                {/if}


                <select class="u-w-fit" on:change={selectTarget}>
                    <option value={null} selected={isEmpty(action?.target)}>
                        {localize("A5E.None")}
                    </option>

                    {#each Object.entries(A5E.targetTypes) as [key, name] (key)}
                        <option value={key} selected={action?.target?.type === key}>
                            {localize(name)}
                        </option>
                    {/each}
                </select>

                {#if ["other"].includes(action?.target?.type)}
                    <input
                        class="small-input"
                        style="width: 15rem;"
                        type="text"
                        name="otherText"
                        value={action.target?.otherText}
                        id={`${appId}-otherText`}
                        on:change={({ target }) =>
                            updateDocumentDataFromField(
                                $item,
                                `system.actions.${actionId}.target.otherText`,
                                // @ts-expect-error
                                target.value
                            )}
                    />
                {/if}

                {#if ["creature", "object", "creatureObject"].includes(action?.target?.type)}
                    <div class="a5e-field-group scaling-button-wrapper">
                        <button
                            class="a5e-scaling-button"
                            on:click|preventDefault={onClickTargetScalingButton}
                        >
                            <i
                                class="fa-solid fa-arrow-up-right-dots"
                                data-tooltip="A5E.ConfigureTargetScaling"
                                data-tooltip-direction="UP"
                            />
                        </button>
                    </div>
                {/if}

                {#if action.target?.scaling?.mode === "cantrip"}
                    <small>
                        {localize("A5E.scaling.summaries.cantrip.target", {
                            formula: action.target?.scaling.formula ?? 0,
                            targetType: A5E.targetTypesPlural[action?.target?.type],
                        })}
                    </small>
                {:else if action.target?.scaling?.mode === "spellLevel"}
                    <small>
                        {#if !action.target?.scaling?.step || action.target?.scaling?.step === 1}
                            {localize("A5E.scaling.summaries.spellLevel.target", {
                                formula: action.target?.scaling.formula ?? 0,
                                level: getOrdinalNumber($item.system.level),
                                targetType: A5E.targetTypesPlural[action?.target?.type],
                            })}
                        {:else}
                            {localize("A5E.scaling.summaries.steppedSpellLevel.target", {
                                formula: action.target?.scaling?.formula ?? 0,
                                step: action.target?.scaling?.step,
                                level: getOrdinalNumber($item.system.level),
                                targetType: A5E.targetTypesPlural[action?.target?.type],
                            })}
                        {/if}
                    </small>
                {:else if action.target?.scaling?.mode === "spellPoints"}
                    <small>
                        {#if !action.target?.scaling?.step || action.target?.scaling?.step === 1}
                            {localize("A5E.scaling.summaries.spellPoint.target", {
                                formula: action.target?.scaling.formula ?? 0,
                                targetType: A5E.targetTypesPlural[action?.target?.type],
                            })}
                        {:else}
                            {localize("A5E.scaling.summaries.steppedSpellPoint.target", {
                                formula: action.target?.scaling?.formula ?? 0,
                                step: action.target?.scaling?.step,
                                targetType: A5E.targetTypesPlural[action?.target?.type],
                            })}
                        {/if}
                    </small>
                {:else if ["actionUses", "itemUses"].includes(action.target?.scaling?.mode)}
                    <small>
                        {#if !action.target?.scaling?.step || action.target?.scaling?.step === 1}
                            {localize("A5E.scaling.summaries.uses.target", {
                                formula: action.target?.scaling.formula ?? 0,
                                targetType: A5E.targetTypesPlural[action?.target?.type],
                            })}
                        {:else}
                            {localize("A5E.scaling.summaries.steppedUses.target", {
                                formula: action.target?.scaling.formula ?? 0,
                                step: action.target?.scaling.step,
                                targetType: A5E.targetTypesPlural[action?.target?.type],
                            })}
                        {/if}
                    </small>
                {/if}
            </div>
        </FieldWrapper>
    </Section>

    <Section --a5e-section-body-direction="row" --a5e-section-body-gap="0.75rem">
        {#if ["creature", "object", "creatureObject", "other"].includes(action?.target?.type)}
            <Checkbox
                label="A5E.TargetHeard"
                checked={action.target?.heard}
                on:updateSelection={({ detail }) =>
                    updateDocumentDataFromField($item, `system.actions.${actionId}.target.heard`, detail)}
            />

            <Checkbox
                label="A5E.TargetSeen"
                checked={action.target?.seen}
                on:updateSelection={({ detail }) =>
                    updateDocumentDataFromField($item, `system.actions.${actionId}.target.seen`, detail)}
            />
        {/if}
    </Section>
    
</section>

<style lang="scss">
    .a5e-page-wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        overflow-y: auto;
        margin: 0;
        margin-right: -0.375rem;
        padding: 0;
        padding-right: 0.375rem;
    }

    .scaling-button-wrapper {
        justify-content: flex-end;
    }
</style>
